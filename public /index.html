<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>YouTube Stream & Download</title>
  <style>
    :root {
      --bg: #121212;
      --card: #1e1e1e;
      --accent: #ff1744;
      --text: #ffffff;
      --subtext: #cccccc;
      --btn: #292929;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .container {
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }
    h1 {
      text-align: center;
      color: var(--accent);
    }
    #suggestions {
      background: var(--btn);
      border-radius: 8px;
      margin-top: -8px;
      margin-bottom: 10px;
      overflow: hidden;
    }
    #suggestions div {
      padding: 8px 10px;
      cursor: pointer;
      border-bottom: 1px solid #333;
    }
    #suggestions div:hover {
      background: var(--accent);
    }
    input[type="text"] {
      width: 100%;
      padding: 12px;
      margin-bottom: 10px;
      background: var(--btn);
      border: none;
      border-radius: 8px;
      color: white;
    }
    .options {
      display: flex;
      justify-content: space-between;
      margin: 10px 0;
    }
    .options select,
    .options button {
      flex: 1;
      padding: 10px;
      margin-right: 8px;
      border: none;
      border-radius: 6px;
      background: var(--btn);
      color: white;
    }
    .options button:last-child {
      margin-right: 0;
    }
    .video-card {
      background: var(--card);
      padding: 12px;
      border-radius: 10px;
      margin-top: 20px;
    }
    .video-card img {
      width: 100%;
      border-radius: 10px;
    }
    .video-info {
      margin-top: 10px;
    }
    .video-info h3 {
      margin: 8px 0 4px;
    }
    .btns {
      display: flex;
      justify-content: space-around;
      margin-top: 15px;
    }
    .btns button {
      padding: 10px 15px;
      background: var(--accent);
      border: none;
      border-radius: 6px;
      color: white;
      font-weight: bold;
    }
    .loading {
      text-align: center;
      color: var(--subtext);
      margin-top: 20px;
    }
    video, audio {
      width: 100%;
      margin-top: 10px;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>YT Downloader</h1>
    <input type="text" id="searchInput" placeholder="üîç Search or paste YouTube link" oninput="suggest()" />
    <div id="suggestions"></div>

    <div class="options">
      <select id="format">
        <option value="mp3">Audio (mp3)</option>
        <option value="mp4">Video (mp4)</option>
      </select>
      <button onclick="fetchVideo()">Go</button>
    </div>

    <div id="result" class="video-card" style="display: none;">
      <img id="thumb" src="" alt="thumbnail" />
      <div class="video-info">
        <h3 id="title"></h3>
        <p id="channel" style="color: var(--subtext); font-size: 14px;"></p>
        <p id="meta" style="color: var(--subtext); font-size: 12px;"></p>
      </div>
      <div class="btns">
        <button onclick="download(false)">Stream</button>
        <button onclick="download(true)">Download</button>
      </div>
      <div id="player"></div>
    </div>

    <div id="loading" class="loading" style="display: none;">‚è≥ Loading...</div>
  </div>

  <script>
    const API_KEY = 'AIzaSyAlRS5xs6RcGSvOIDztVRX0g2EjQXvCaN0';
    const BASE_API = 'https://www.googleapis.com/youtube/v3';
    let currentVideo = null;

    function suggest() {
      const q = document.getElementById('searchInput').value;
      if (!q || q.includes("youtube.com") || q.includes("youtu.be")) return document.getElementById("suggestions").innerHTML = "";

      fetch(`${BASE_API}/search?part=snippet&type=video&maxResults=5&q=${encodeURIComponent(q)}&key=${API_KEY}`)
        .then(res => res.json())
        .then(data => {
          const suggestions = data.items.map(v => `<div onclick="selectSuggestion('${v.id.videoId}', '${v.snippet.title.replace(/'/g, "\\'")}')">${v.snippet.title}</div>`).join('');
          document.getElementById("suggestions").innerHTML = suggestions;
        });
    }

    function selectSuggestion(id, title) {
      document.getElementById('searchInput').value = title;
      document.getElementById("suggestions").innerHTML = "";
      fetchInfo(id);
    }

    function fetchVideo() {
      const input = document.getElementById('searchInput').value;
      document.getElementById('loading').style.display = 'block';
      document.getElementById('result').style.display = 'none';
      document.getElementById("player").innerHTML = "";

      if (input.includes('youtube.com') || input.includes('youtu.be')) {
        const id = extractID(input);
        fetchInfo(id);
      } else {
        fetch(`${BASE_API}/search?part=snippet&type=video&maxResults=1&q=${encodeURIComponent(input)}&key=${API_KEY}`)
          .then(res => res.json())
          .then(data => {
            if (data.items.length) fetchInfo(data.items[0].id.videoId);
            else alert("No results found.");
          });
      }
    }

    function extractID(url) {
      const regExp = /^.*((youtu.be\/)|(v\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
      const match = url.match(regExp);
      return (match && match[6].length === 11) ? match[6] : null;
    }

    function fetchInfo(videoId) {
      currentVideo = videoId;
      fetch(`${BASE_API}/videos?part=snippet,statistics,contentDetails&id=${videoId}&key=${API_KEY}`)
        .then(res => res.json())
        .then(data => {
          const vid = data.items[0];
          document.getElementById('title').innerText = vid.snippet.title;
          document.getElementById('channel').innerText = vid.snippet.channelTitle;
          document.getElementById('thumb').src = vid.snippet.thumbnails.high.url;
          document.getElementById('meta').innerText = `${vid.statistics.viewCount} views ‚Ä¢ Published: ${vid.snippet.publishedAt.slice(0, 10)}`;
          document.getElementById('result').style.display = 'block';
          document.getElementById('loading').style.display = 'none';
        });
    }

    function download(isDownload) {
      const format = document.getElementById('format').value;
      const url = `/api/download?url=https://www.youtube.com/watch?v=${currentVideo}&format=${format}`;

      if (isDownload) {
        window.open(url, '_blank');
      } else {
        const tag = format === 'mp3' ? 'audio' : 'video';
        const media = document.createElement(tag);
        media.src = url;
        media.controls = true;
        media.autoplay = true;
        document.getElementById("player").innerHTML = "";
        document.getElementById("player").appendChild(media);
      }
    }
  </script>
</body>
</html>
